# Приложение на Java

## Описание проекта

Этот проект представляет собой серверную часть приложения, написанную на Java. Он включает в себя собственную реализацию HTTP-сервера, кастомные сервлеты, JWT-аутентификацию и бизнес-логику для управления пользователями. Проект спроектирован таким образом, чтобы поддерживать гибкую маршрутизацию запросов, управление пользователями и обработку HTTP-запросов.

### Основные компоненты

- **HTTP-сервер**: Обеспечивает низкоуровневую обработку HTTP-запросов, управление соединениями и конфигурацией сервера.
- **Сервлеты**: Реализуют маршрутизацию и обработку HTTP-запросов с использованием аннотаций и кастомных фильтров для аутентификации и авторизации.
- **Бизнес-логика**: Управление пользователями, включая регистрацию, аутентификацию, обновление данных и удаление пользователей.
- **JWT-аутентификация**: Обеспечивает защиту API с помощью токенов, что позволяет безопасно аутентифицировать пользователей.

## Описание состава и функционала пакетов

### Пакет `webserver`

Пакет `webserver` отвечает за реализацию основного функционала HTTP-сервера. Он включает в себя классы для обработки HTTP-запросов, управления соединениями, обработки заголовков и статусов, а также интерфейсы для обработки запросов.

#### Основные классы и их функции:

1. **`HttpServer.java`**:
    - Этот класс реализует основной HTTP-сервер, который прослушивает определённый порт для входящих HTTP-соединений.
    - Управляет жизненным циклом сервера, включая запуск, остановку и перезапуск сервера.
    - Включает методы для инициализации и обработки входящих соединений.

2. **`ConfigLoader.java`**:
    - Отвечает за загрузку конфигурационных параметров сервера из внешних файлов конфигурации.
    - Позволяет серверу гибко адаптироваться к различным условиям работы без необходимости изменения исходного кода.

3. **`ConnectionHandler.java`**:
    - Управляет входящими соединениями, принимая их и распределяя на соответствующие обработчики запросов.
    - Основная задача этого класса - обеспечение корректного и эффективного распределения нагрузки на сервере.

4. **`HttpParser.java`** (внутри пакета `parser`):
    - Класс, занимающийся синтаксическим разбором HTTP-запросов.
    - Он извлекает необходимые данные из текстового представления запроса, такие как метод, заголовки и тело запроса.

5. **Классы в пакете `http`**:
    - **`HttpHeader.java` и `HttpHeaders.java`**: Управляют HTTP-заголовками. `HttpHeader.java` представляет собой один заголовок, а `HttpHeaders.java` — коллекцию заголовков.
    - **`HttpMethod.java`**: Перечисление (enum), содержащее возможные HTTP-методы (GET, POST, PUT, DELETE и т.д.).
    - **`HttpStatus.java`**: Перечисление всех возможных HTTP-статусов, таких как `200 OK`, `404 Not Found`, `500 Internal Server Error`.
    - **`HttpRequest.java`**: Представляет HTTP-запрос, включая метод, путь, заголовки и тело запроса.
    - **`HttpResponse.java`**: Представляет HTTP-ответ, содержащий статус, заголовки и тело ответа.

6. **Интерфейсы в пакете `interfaces`**:
    - **`RequestHandler.java`**: Интерфейс, определяющий метод для обработки HTTP-запросов. Классы, реализующие этот интерфейс, должны обрабатывать запросы и возвращать соответствующий HTTP-ответ.

### Пакет `servlets`

Пакет `servlets` отвечает за обработку HTTP-запросов и управление сервлетами. Он включает фильтры для обработки запросов, утилиты для работы с токенами и JSON, модели для представления HTTP-запросов и ответов, а также исключения и аннотации для работы с маршрутами.

#### Основные компоненты пакета `servlets`:

1. **Классы диспетчера и фильтров:**
    - **`ServletDispatcher.java`**: Класс, ответственный за маршрутизацию и обработку входящих HTTP-запросов. Он выполняет сопоставление маршрутов и перенаправляет запросы к соответствующим сервлетам.
    - **`FilterChain.java`**: Реализует цепочку фильтров, через которую проходят запросы перед их обработкой сервлетами. Это позволяет последовательно применять несколько фильтров безопасности или других промежуточных обработок.
    - **`JwtAuthenticationFilter.java`**: Фильтр, отвечающий за аутентификацию на основе JWT. Проверяет наличие и валидность токена в заголовке запроса и, если он действителен, добавляет информацию о пользователе в контекст запроса.
    - **`PathAvailabilityFilter.java`**: Фильтр, проверяющий доступность запрашиваемого пути, возвращая ошибку, если путь недоступен или не существует.
    - **`Filter.java`**: Базовый интерфейс или абстрактный класс, который должны реализовывать все фильтры.

2. **Утилиты:**
    - **`BearerAuthentication.java`**: Утилита для обработки аутентификации на основе Bearer токенов.
    - **`JwtUtils.java`**: Класс для работы с JWT токенами, включая их создание, валидацию и извлечение информации.
    - **`ObjectMapperSingleton.java`**: Утилита для работы с JSON, предоставляющая единственный экземпляр ObjectMapper для сериализации и десериализации объектов.

3. **Модели:**
    - **`HttpServletRequest.java`** и **`HttpServletResponse.java`**: Классы, представляющие HTTP-запросы и ответы соответственно. `HttpServletRequest` содержит информацию о запросе, такую как метод, заголовки и тело. `HttpServletResponse` используется для формирования ответа с указанием статуса, заголовков и тела.
    - **`Route.java`**: Класс, представляющий маршрут (путь), используемый в маршрутизации запросов.
    - **`RequestContext.java`**: Класс, содержащий информацию о текущем запросе, которая может использоваться в течение всей обработки запроса.
    - **`ServletContext.java`**: Класс, представляющий контекст сервлета, включающий информацию и настройки, доступные всем сервлетам.
    - **`Servlet.java`** и **`HttpServlet.java`**: Базовые классы для всех сервлетов, предоставляющие методы для обработки различных HTTP-методов, таких как GET, POST, PUT, DELETE.
    - **`Error.java`**: Класс, представляющий ошибку, возникшую во время обработки запроса.

4. **Исключения:**
    - **`TokenNotValidException.java`**: Исключение, выбрасываемое в случае, если JWT токен недействителен.
    - **`ServiceException.java`**: Общее исключение для ошибок сервиса.
    - **`GlobalExceptionHandler.java`**: Класс, ответственный за глобальную обработку исключений в приложении.
    - **`BadRequestException.java`**: Исключение, выбрасываемое при некорректных запросах от клиента.
    - **`AuthorizationException.java`**: Исключение, выбрасываемое при ошибках авторизации.
    - **`TokenFormatException.java`**: Исключение, выбрасываемое при некорректном формате JWT токена.

5. **Аннотации:**
    - **`PutRoute.java`, `GetRoute.java`, `PostRoute.java`, `DeleteRoute.java`**: Аннотации для маркировки методов в сервлетах, которые обрабатывают соответствующие HTTP-методы.
    - **`PathVariable.java`**: Аннотация для обозначения переменных в пути запроса, которые должны быть извлечены и переданы в метод.
    - **`RequestParam.java`**: Аннотация для извлечения параметров запроса.
    - **`RequestBody.java`**: Аннотация для указания, что тело запроса должно быть десериализовано в объект и передано в метод сервлета.

6. **Роутинг:**
    - **`RouteMatcher.java`**: Класс для сопоставления входящих запросов с маршрутами, извлекая переменные пути и сохраняя их в контексте запроса.
    - **`ServletScanner.java`**: Класс для сканирования пакетов на наличие классов, помеченных аннотациями маршрутов, и их регистрации.
    - **`RequestProcessor.java`**: Основной класс, отвечающий за обработку запросов и маршрутизацию к соответствующим сервлетам и методам.

### Пакет `domain`

Пакет `domain` отвечает за управление бизнес-логикой, связанной с пользователями и их регистрацией, аутентификацией и обновлением данных. Он включает в себя репозитории для взаимодействия с базой данных, сервисы для обработки данных, контроллеры для управления запросами, сущности для представления данных и исключения для обработки ошибок.

#### Основные компоненты пакета `domain`:

1. **Репозитории:**
    - **`ConnectionsManager.java`**: Класс, управляющий соединениями с базой данных или другими внешними сервисами. Обеспечивает управление и реиспользование соединений, что улучшает производительность и устойчивость приложения.
    - **`UserRepository.java`**: Репозиторий, отвечающий за операции с пользователями в базе данных. Включает методы для поиска, создания, обновления и удаления пользователей.

2. **Исключения:**
    - **`UserAlreadyExistException.java`**: Исключение, выбрасываемое в случае, если попытка создать нового пользователя не удалась, потому что пользователь с таким идентификатором уже существует.
    - **`UserNotFoundException.java`**: Исключение, выбрасываемое, когда запрашиваемый пользователь не найден в базе данных.

3. **Контроллеры:**
    - **`SignInController.java`**: Контроллер, отвечающий за обработку запросов на вход (аутентификацию) пользователей. Проверяет логин и пароль, а также генерирует JWT токен в случае успешной аутентификации.
    - **`SignUpController.java`**: Контроллер для обработки запросов на регистрацию новых пользователей. Принимает данные, такие как имя пользователя, пароль и другие атрибуты, и передает их в сервис для создания нового пользователя.
    - **`UserController.java`**: Контроллер, управляющий запросами, связанными с пользователями, такими как получение списка пользователей, обновление данных пользователя и удаление пользователя.

4. **Сервисы:**
    - **`UserService.java`**: Сервис, обрабатывающий бизнес-логику, связанную с пользователями. Этот класс выполняет основную работу по управлению пользователями, включая валидацию данных, взаимодействие с репозиториями и обработку исключений.

5. **Сущности:**
    - **`User.java`**: Основная сущность, представляющая пользователя в системе. Включает атрибуты, такие как идентификатор, имя пользователя, пароль и другие данные.
    - **`UserRegistrationDTO.java`**: Data Transfer Object (DTO) для передачи данных, необходимых для регистрации нового пользователя. Этот класс используется контроллерами для получения данных от клиента.
    - **`UserUpdateDTO.java`**: DTO для передачи данных, необходимых для обновления информации о пользователе.
    - **`UserLoginDTO.java`**: DTO для передачи данных при входе пользователя, таких как имя пользователя и пароль.

## Применение

Каждый из пакетов предоставляет набор инструментов для реализации и управления функционалом серверной части приложения. `webserver` отвечает за обработку запросов, `servlets` — за маршрутизацию и аутентификацию, а `domain` — за управление пользователями и их данными.


## Настройка окружения

Для развертывания базы данных с помощью Docker Compose, убедитесь, что файл `.env` находится в корневой директории вашего проекта. Этот файл должен содержать следующие переменные окружения, необходимые для настройки подключения к базе данных:

- `POSTGRES_USER`
- `POSTGRES_PASSWORD`
- `POSTGRES_DB`
- `PGDATA`

Эти переменные используются в `docker-compose.yml` для настройки контейнера PostgreSQL. 
Пример содержания файла `.env`:

```dotenv
POSTGRES_USER=your_db_user
POSTGRES_PASSWORD=your_db_password
POSTGRES_DB=your_db_name
PGDATA=/var/lib/postgresql/data
```

## Точка входа и параметры конфигурации

Точка входа в проект представлена классом `Application`. Он инициализирует и запускает HTTP-сервер.

### Параметры конфигурации

Параметры сервера можно задать несколькими способами:

- **Системные свойства**: Например, порт сервера может быть установлен через системное свойство `server.port`.
- **VM Options**: Например, порт сервера может быть установлен через VM Option `-Dserver.port=<port>`. Это позволяет гибко задавать параметры при запуске приложения.
- **Файл конфигурации `application.properties`**: Если системные свойства не заданы, параметры загружаются из этого файла с помощью класса `ConfigLoader`.

**Пример параметров конфигурации:**

```properties
server.port=8080
database.url=jdbc:postgresql://localhost:5432/UserService
database.user=User
database.password=Password
jwt.expiration.time=86400000
jwt.secret.key=секретный_ключ
```



## Примеры использования

### 1. Регистрация нового пользователя

**Описание:**
- **Метод:** `POST`
- **Путь:** `/signup`
- Этот запрос используется для создания нового пользователя в системе. Запрос должен содержать JSON с данными пользователя, такими как имя пользователя и пароль.

**Пример запроса:**

```bash
curl -X POST http://localhost:8080/signup \
-H "Content-Type: application/json" \
-d '{
  "username": "new_user",
  "password": "secure_password"
}'
```

### 2. Вход пользователя и получение JWT токена

**Описание:**
- **Метод:** `POST`
- **Путь:** `/signin`
- Этот запрос используется для аутентификации пользователя и возвращает JWT токен в заголовке ответа.

**Пример запроса:**
```bash
curl -X POST http://localhost:8080/signin \
-H "Content-Type: application/json" \
-d '{
  "username": "existing_user",
  "password": "correct_password"
}'
```

### 3. Использование JWT токена для защищенных запросов

**Описание:**
- **Метод:** `GET`
- **Путь:** `/users`
- Возвращает список всех зарегистрированных пользователей.
- 
**Пример запроса:**
```bash
curl -X GET http://localhost:8080/users \
-H "Authorization: Bearer <jwt_token>"

```
### 4. Получение информации о конкретном пользователе

**Описание:**
- **Метод:** `GET`
- **Путь:** `/users/{id}`
- Возвращает информацию о пользователе по его ID.
- 
**Пример запроса:**
```bash
curl -X GET http://localhost:8080/users/1 \
-H "Authorization: Bearer <jwt_token>"
```
### 5. Обновление данных пользователя

**Описание:**
- **Метод:** `PUT`
- **Путь:** `/users/{id}`
- Обновляет данные пользователя по ID.
- 
**Пример запроса:**
```bash
curl -X PUT http://localhost:8080/users/1 \
-H "Authorization: Bearer <jwt_token>" \
-H "Content-Type: application/json" \
-d '{
  "username": "updated_user",
  "password": "new_password"
}'
```
### 6. Удаление пользователя

**Описание:**
- **Метод:** `DELETE`
- **Путь:** `/users/{id}`
- Удаляет пользователя из системы по его ID.
- 
**Пример запроса:**
```bash
curl -X DELETE http://localhost:8080/users/1 \
-H "Authorization: Bearer <jwt_token>"
```

### 7. Поиск пользователя по имени

**Описание:**
- **Метод:** `GET`
- **Путь:** `/users/search`
- Этот запрос используется для поиска пользователя по его имени пользователя (логину). Параметр `username` передается как параметр запроса.

**Пример запроса:**

```bash
curl -X GET "http://localhost:8080//users/search?username=some_username" \
-H "Authorization: Bearer <jwt_token>"
```